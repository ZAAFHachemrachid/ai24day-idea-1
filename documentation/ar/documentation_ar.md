# نظام تسجيل الحضور بالتعرف على الوجه - التوثيق

## نظرة عامة على النظام

نظام تسجيل الحضور بالتعرف على الوجه هو تطبيق متطور يستخدم الرؤية الحاسوبية والتعلم الآلي لأتمتة تتبع الحضور من خلال التعرف على الوجه. يوفر النظام اكتشاف الوجه في الوقت الفعلي والتعرف عليه وإدارة الحضور من خلال واجهة مستخدم رسومية سهلة الاستخدام.

## الميزات

### الميزات الأساسية
- اكتشاف الوجه والتعرف عليه في الوقت الفعلي
- تتبع الحضور الآلي
- تسجيل المستخدم مع عينات الوجه
- اكتشاف ملامح الوجه (العيون والفم)
- تتبع حالة الحضور/الغياب
- مراقبة الأداء والإحصائيات

### الميزات التقنية
- اكتشاف الوجه متعدد المقاييس
- تتبع الوجه لتحسين الأداء
- معالجة محسّنة للفيديو
- معلمات اكتشاف قابلة للتكوين
- دعم الكاميرا عالية الدقة (Full HD)
- قاعدة بيانات SQLite للحفاظ على البيانات

## البنية التقنية

### المكونات

1. **التطبيق الرئيسي (`main.py`)**
   - نقطة الدخول للتطبيق
   - تهيئة واجهة المستخدم الرسومية والمكونات الأساسية

2. **واجهة المستخدم (`ui/`)**
   - `main_window.py`: النافذة الرئيسية للتطبيق
   - `widgets.py`: مكونات واجهة المستخدم المخصصة
   - `dialogs.py`: مربعات حوار التسجيل والعرض

3. **التعرف على الوجه (`face_recognition/`)**
   - `recognition.py`: منطق التعرف الأساسي مع تعرف محسّن حسب المسافة
   - `initializers.py`: إعداد نماذج اكتشاف الوجه
   - يستخدم InsightFace للكشف الدقيق عن الوجه والتعرف عليه
   - تعرف متعدد المقاييس مع حسابات تشابه محسّنة
   - اكتشاف المعالم الوجهية للعيون والفم
   - ميزات تعرف محسنة:
     * ترجيح التشابه حسب المسافة
     * مقارنة التضمين متعددة المقاييس
     * عودة مبكرة للتطابقات عالية الثقة
     * مقارنات تضمين معيارية
     * عتبات تعرف قابلة للتكوين

4. **نظام التتبع (`tracking/`)**
   - `tracker.py`: تنفيذ متقدم لتتبع الوجه
   - يحسن الأداء من خلال:
     * فترات اكتشاف تكيفية
     * تصفية الوجه على أساس الحجم
     * معالجة مسبقة للإطارات وتحجيمها
     * تتبع مستمر بين عمليات الاكتشاف
     * إعادة تهيئة تلقائية للمتتبع
   - ميزات تتبع ذكية:
     * توليد معرف الوجه للتتبع المتسق
     * تتبع آخر إطار مرئي
     * تحجيم الإحداثيات الأصلية
     * معلمات تتبع قابلة للتكوين
     * تغذية راجعة مرئية للتتبع

5. **نظام الحضور (`attendance/`)**
   - `logger.py`: تسجيل وإدارة الحضور
   - يتتبع حالة الحضور/الغياب
   - يولد تقارير الحضور

### بنية قاعدة البيانات

يستخدم النظام SQLite مع SQLAlchemy ORM، ويتكون من النماذج التالية:

1. **المستخدم**
   - معلومات المستخدم الأساسية
   - روابط لعينات الوجه وأحداث التعرف

2. **عينة الوجه**
   - عينات الوجه المخزنة للتعرف
   - روابط للمستخدمين المرتبطين

3. **المكان**
   - تتبع الموقع لأحداث التعرف
   - يدعم النشر متعدد المواقع

4. **حدث التعرف**
   - سجلات حدوث التعرف على الوجه
   - يتضمن درجات الثقة والطوابع الزمنية

5. **نظام الحضور**
   - سجلات الحضور اليومية
   - يتتبع أوقات تسجيل الدخول/الخروج والمدة
   - مراقبة الحضور في الوقت الفعلي
   - ميزات تسجيل الحضور التلقائي:
     * سجلات حضور بتنسيق CSV
     * تتبع الحضور على أساس الطابع الزمني
     * عتبة غياب قابلة للتكوين (30 ثانية افتراضياً)
     * تسجيل المغادرة التلقائي
     * تحديثات مستمرة لحالة الحضور

## التكوين

### تكوين الكاميرا
```python
CAMERA_CONFIG = {
    'width': 1920,  # Full HD
    'height': 1080,
    'fps': 30,
    'buffer_size': 1  # تأخير منخفض
}
```

### تكوين الاكتشاف
```python
DETECTION_CONFIG = {
    'detection_interval': 5,
    'min_face_size': 20,
    'max_face_size': 400,
    'recognition_threshold': 0.45,
    'tracking_confidence_threshold': 0.55,
    'processing_width': 1280,
    'enable_tracking': True,
    'use_face_landmarks': True,
    'optimize_for_distance': True,
    'recognition_scales': [1.0, 0.75, 1.25]
}
```

## دليل الاستخدام

### 1. بدء التطبيق
- تشغيل `main.py` لإطلاق التطبيق
- يقوم النظام تلقائياً بتهيئة الكاميرا ونماذج التعرف على الوجه

### 2. تسجيل المستخدم
- النقر على زر "تسجيل" في لوحة التحكم
- التقاط عينات الوجه للمستخدم الجديد
- إدخال معلومات المستخدم في مربع حوار التسجيل

### 3. مراقبة الحضور
- يكتشف النظام تلقائياً الوجوه ويتعرف عليها
- يتم تتبع المستخدمين الحاضرين في الوقت الفعلي
- يتم تحديث حالة الغياب بعد 30 ثانية من الغياب
- ميزات سجل الحضور:
  * إنشاء وإدارة ملف CSV تلقائياً
  * تسجيل الوصول والمغادرة في الوقت الفعلي
  * سجل حضور مستمر
  * تتبع مستمر للحضور
  * تحديثات ذكية للحالة للغيابات المؤقتة
  * تتبع عدة أشخاص في نفس الوقت
  * تهيئة تلقائية لملف السجل

### 4. عرض السجلات
- استخدام "عرض السجلات" للتحقق من سجلات الحضور
- "عرض الوجوه" يظهر عينات وجوه المستخدمين المسجلين
- يتم عرض إحصائيات الأداء في الوقت الفعلي

### 5. اكتشاف ملامح الوجه
- تمكين/تعطيل اكتشاف العين والفم
- اختيار ألوان تمييز الاكتشاف
- ضبط معلمات الاكتشاف حسب الحاجة
- اكتشاف دقيق للمعالم الوجهية:
  * اكتشاف تلقائي لمنطقة العين (مناطق 30×20 بكسل)
  * حساب ديناميكي لمنطقة الفم بناءً على زوايا الفم
  * تحجيم متناسب للملامح الوجهية
  * تتبع وتصور الملامح في الوقت الفعلي

## تحسين الأداء

يتضمن النظام العديد من التحسينات:
- تتبع متقدم للوجه:
  * اكتشاف دوري بدلاً من تحليل إطار بإطار
  * تهيئة وإعادة تعيين ذكية للتتبع
  * تصفية الوجه على أساس الحجم لتقليل النتائج الإيجابية الخاطئة
  * تحجيم كفء للإحداثيات لمختلف الدقات
  * التحقق من ثقة التتبع
- تحسينات التعرف:
  * تعرف متعدد المقاييس لدقة محسنة
  * حسابات تشابه تراعي المسافة
  * عودة مبكرة للتطابقات عالية الثقة
- تحسينات النظام:
  * التقاط فيديو مخزن مؤقتاً لتقليل التأخير
  * معالجة مسبقة وتحجيم للإطارات
  * فترات اكتشاف قابلة للتكوين
  * خط معالجة محسن للإطارات
  * تخزين كفء لبيانات الوجه في الذاكرة

## إدارة البيانات

- يتم تخزين عينات الوجه في `face_data/`
- يتم حفظ سجلات الحضور بتنسيق CSV
- يتم تسجيل أحداث التعرف في قاعدة بيانات SQLite
- تنظيف تلقائي للسجلات القديمة (قابل للتكوين)

## متطلبات النظام

- Python 3.7+
- OpenCV
- SQLite
- Tkinter
- InsightFace
- مساحة قرص مطلوبة لعينات الوجه وقاعدة البيانات

## معالجة الأخطاء

يتضمن النظام معالجة قوية للأخطاء لـ:
- مشاكل اتصال الكاميرا
- أخطاء قاعدة البيانات
- فشل اكتشاف/التعرف على الوجه
- عمليات إدخال/إخراج الملفات
- إدارة الذاكرة